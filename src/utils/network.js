"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.netRequest = exports.uploadFile = void 0;
const config_1 = require("../config/config");
const util_1 = require("./util");
const app = (getApp());
const serverErrorPattern = new RegExp('^5..$');
const clientErrorPattern = new RegExp('^4..$');
const redirectPattern = new RegExp('^3..$');
const okPattern = new RegExp('^2..$');
function uploadFile(filePath, folder, self) {
    let key = `${config_1.default.OSS_BUCKET}/${folder}/${util_1.uuid()}`;
    ossSignature().then((res) => {
        let signature = res.data;
        let uploader = wx.uploadFile({
            url: config_1.default.OSS_ROOT,
            filePath: filePath,
            name: 'file',
            formData: {
                name: filePath,
                key: key,
                policy: signature.policy,
                OSSAccessKeyId: signature.ossAccessKeyId,
                signature: signature.signature,
                success_action_status: "200",
                'x-oss-security-token': signature.securityToken
            },
            success: (res) => {
                if (res.statusCode === 204) {
                    console.log('上传成功');
                }
                self.setData({
                    imageSrc: `${config_1.default.OSS_ROOT}/${key}`
                });
            },
            fail: err => {
                console.log(err);
            }
        });
        uploader.onProgressUpdate(res => {
            self.setData({
                uploadProgress: res.progress
            });
        });
    }).catch((res) => {
        console.error(res);
    });
}
exports.uploadFile = uploadFile;
function ossSignature() {
    return netRequest('/aliyun/oss-signature', 'GET');
}
function netRequest(url, method, params = null, data = null) {
    var _a, _b;
    var headers = {};
    var authorization = (_a = app.auth) === null || _a === void 0 ? void 0 : _a.accessToken;
    if (authorization != null) {
        if (isExpired()) {
            util_1.wechatLogin((res) => {
                var _a;
                let result = res.data;
                app.auth = result.auth;
                app.user = result.user;
                headers = {
                    Authorization: `Bearer ${(_a = app.auth) === null || _a === void 0 ? void 0 : _a.accessToken}`
                };
            });
        }
        else {
            headers = {
                Authorization: `Bearer ${(_b = app.auth) === null || _b === void 0 ? void 0 : _b.accessToken}`
            };
        }
    }
    return createRequestPromise(url, method, params, data, headers);
}
exports.netRequest = netRequest;
function createRequestPromise(url, method, params = null, data = null, headers) {
    return new Promise((resolve, reject) => {
        wx.request({
            url: `${config_1.default.API}${url}${resolveParams(params)}`,
            data: data,
            method: method,
            header: headers,
            dataType: "json",
            responseType: "text",
            success: (res) => {
                if (isSuccess(res)) {
                    resolve(res);
                }
                else {
                    reject(res);
                }
            },
            fail: (res) => {
                console.error('request error');
                reject(res);
            },
            complete: (res) => {
            }
        });
    });
}
function isExpired() {
    return app.auth.expiration < new Date().getMilliseconds();
}
function resolveParams(params) {
    if (params != null) {
        let paramsStr = '?';
        params.forEach((value, key) => {
            paramsStr += `${key}=${value}&`;
        });
        return paramsStr.substring(0, paramsStr.length - 1);
    }
    return '';
}
function isSuccess(res) {
    let statusCode = String(res.statusCode);
    return !serverErrorPattern.test(statusCode) && !clientErrorPattern.test(statusCode);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmV0d29yay5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIm5ldHdvcmsudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBRUEsNkNBQXNDO0FBQ3RDLGlDQUEyQztBQUUzQyxNQUFNLEdBQUcsR0FBZ0IsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDO0FBR3BDLE1BQU0sa0JBQWtCLEdBQUcsSUFBSSxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUM7QUFHL0MsTUFBTSxrQkFBa0IsR0FBRyxJQUFJLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQztBQUcvQyxNQUFNLGVBQWUsR0FBRyxJQUFJLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQztBQUc1QyxNQUFNLFNBQVMsR0FBRyxJQUFJLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQztBQVN0QyxTQUFnQixVQUFVLENBQUMsUUFBZ0IsRUFBRSxNQUFjLEVBQUUsSUFBcUc7SUFDaEssSUFBSSxHQUFHLEdBQUcsR0FBRyxnQkFBTSxDQUFDLFVBQVUsSUFBSSxNQUFNLElBQUksV0FBSSxFQUFFLEVBQUUsQ0FBQztJQUVyRCxZQUFZLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFtRCxFQUFFLEVBQUU7UUFDMUUsSUFBSSxTQUFTLEdBQWlCLEdBQUcsQ0FBQyxJQUFJLENBQUM7UUFHdkMsSUFBSSxRQUFRLEdBQUcsRUFBRSxDQUFDLFVBQVUsQ0FBQztZQUMzQixHQUFHLEVBQUUsZ0JBQU0sQ0FBQyxRQUFRO1lBQ3BCLFFBQVEsRUFBRSxRQUFRO1lBQ2xCLElBQUksRUFBRSxNQUFNO1lBQ1osUUFBUSxFQUFFO2dCQUNSLElBQUksRUFBRSxRQUFRO2dCQUNkLEdBQUcsRUFBRSxHQUFHO2dCQUNSLE1BQU0sRUFBRSxTQUFTLENBQUMsTUFBTTtnQkFDeEIsY0FBYyxFQUFFLFNBQVMsQ0FBQyxjQUFjO2dCQUN4QyxTQUFTLEVBQUUsU0FBUyxDQUFDLFNBQVM7Z0JBQzlCLHFCQUFxQixFQUFFLEtBQUs7Z0JBQzVCLHNC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QUMsVUFBVSxDQUFDLENBQUM7QUFDdEYsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8vIGltcG9ydCAnbWluaXByb2dyYW0tYXBpLXR5cGluZ3MnO1xuLy8vIDxyZWZlcmVuY2UgbGliPVwiZG9tXCIgLz5cbmltcG9ydCBDb25maWcgZnJvbSBcIi4uL2NvbmZpZy9jb25maWdcIjtcbmltcG9ydCB7IHV1aWQsIHdlY2hhdExvZ2luIH0gZnJvbSBcIi4vdXRpbFwiO1xuXG5jb25zdCBhcHAgPSA8TXlBcHBPcHRpb24+KGdldEFwcCgpKTtcblxuLy8gNXh4IHN0YXR1cyBjb2RlXG5jb25zdCBzZXJ2ZXJFcnJvclBhdHRlcm4gPSBuZXcgUmVnRXhwKCdeNS4uJCcpOyAvLyBvciAvXjUuLiQvXG5cbi8vIDR4eFxuY29uc3QgY2xpZW50RXJyb3JQYXR0ZXJuID0gbmV3IFJlZ0V4cCgnXjQuLiQnKTtcblxuLy8gM3h4XG5jb25zdCByZWRpcmVjdFBhdHRlcm4gPSBuZXcgUmVnRXhwKCdeMy4uJCcpO1xuXG4vLyAyeHhcbmNvbnN0IG9rUGF0dGVybiA9IG5ldyBSZWdFeHAoJ14yLi4kJyk7XG5cblxuLyoqXG4gKiBVcGxvYWQgZmlsZSBmdW5jdGlvblxuICogQHBhcmFtIGZpbGVQYXRoIFRoZSBmaWxlIHRvIGJlIHVwbG9hZC5cbiAqIEBwYXJhbSBmb2xkZXIgRmlsZSBwYXRoIGFwcGVuZCB0byBPU1NfUk9PVC5cbiAqIEBwYXJhbSBzZWxmIENvbXBvbmVudCBvciBQYWdlIEluc3RhbmNlLlxuICovXG5leHBvcnQgZnVuY3Rpb24gdXBsb2FkRmlsZShmaWxlUGF0aDogc3RyaW5nLCBmb2xkZXI6IHN0cmluZywgc2VsZjogV2VjaGF0TWluaXByb2dyYW0uQ29tcG9uZW50Lkluc3RhbmNlPGFueSwgYW55LCBhbnk+IHwgV2VjaGF0TWluaXByb2dyYW0uUGFnZS5JbnN0YW5jZTxhbnksIGFueT4pIHtcbiAgbGV0IGtleSA9IGAke0NvbmZpZy5PU1NfQlVDS0VUfS8ke2ZvbGRlcn0vJHt1dWlkKCl9YDtcbiAgLy8gUmVxdWVzdCBvc3MgdXBsb2FkIHNpZ25hdHVyZS5cbiAgb3NzU2lnbmF0dXJlKCkudGhlbigocmVzOiBXZWNoYXRNaW5pcHJvZ3JhbS5SZXF1ZXN0U3VjY2Vzc0NhbGxiYWNrUmVzdWx0KSA9PiB7XG4gICAgbGV0IHNpZ25hdHVyZSA9IDxPc3NTaWduYXR1cmU+cmVzLmRhdGE7XG5cbiAgICAvLyB1cGxvYWQgZmlsZS5cbiAgICBsZXQgdXBsb2FkZXIgPSB3eC51cGxvYWRGaWxlKHtcbiAgICAgIHVybDogQ29uZmlnLk9TU19ST09ULCAvLyDlvIDlj5HogIXmnI3liqHlmajnmoRVUkzjgIJcbiAgICAgIGZpbGVQYXRoOiBmaWxlUGF0aCxcbiAgICAgIG5hbWU6ICdmaWxlJywgLy8g5b+F6aG75aGrZmlsZeOAglxuICAgICAgZm9ybURhdGE6IHtcbiAgICAgICAgbmFtZTogZmlsZVBhdGgsXG4gICAgICAgIGtleToga2V5LFxuICAgICAgICBwb2xpY3k6IHNpZ25hdHVyZS5wb2xpY3ksXG4gICAgICAgIE9TU0FjY2Vzc0tleUlkOiBzaWduYXR1cmUub3NzQWNjZXNzS2V5SWQsXG4gICAgICAgIHNpZ25hdHVyZTogc2lnbmF0dXJlLnNpZ25hdHVyZSxcbiAgICAgICAgc3VjY2Vzc19hY3Rpb25fc3RhdHVzOiBcIjIwMFwiLFxuICAgICAgICAneC1vc3Mtc2VjdXJpdHktdG9rZW4nOiBzaWduYXR1cmUuc2VjdXJpdHlUb2tlbiAvLyDkvb/nlKhTVFPnrb7lkI3ml7blv4XkvKDjgIJcbiAgICAgIH0sXG4gICAgICBzdWNjZXNzOiAocmVzKSA9PiB7XG4gICAgICAgIGlmIChyZXMuc3RhdHVzQ29kZSA9PT0gMjA0KSB7XG4gICAgICAgICAgY29uc29sZS5sb2coJ+S4iuS8oOaIkOWKnycpO1xuICAgICAgICB9XG4gICAgICAgIHNlbGYuc2V0RGF0YSh7XG4gICAgICAgICAgaW1hZ2VTcmM6IGAke0NvbmZpZy5PU1NfUk9PVH0vJHtrZXl9YFxuICAgICAgICB9KTtcbiAgICAgIH0sXG4gICAgICBmYWlsOiBlcnIgPT4ge1xuICAgICAgICBjb25zb2xlLmxvZyhlcnIpO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgLy8gVXBkYXRlIHByb2dyZXNzLlxuICAgIHVwbG9hZGVyLm9uUHJvZ3Jlc3NVcGRhdGUocmVzID0+IHtcbiAgICAgIHNlbGYuc2V0RGF0YSh7XG4gICAgICAgIHVwbG9hZFByb2dyZXNzOiByZXMucHJvZ3Jlc3NcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9KS5jYXRjaCgocmVzOiBXZWNoYXRNaW5pcHJvZ3JhbS5SZXF1ZXN0RmFpbENhbGxiYWNrKSA9PiB7XG4gICAgY29uc29sZS5lcnJvcihyZXMpO1xuICB9KTtcbn1cblxuXG5mdW5jdGlvbiBvc3NTaWduYXR1cmUoKSB7XG4gIHJldHVybiBuZXRSZXF1ZXN0KCcvYWxpeXVuL29zcy1zaWduYXR1cmUnLCAnR0VUJyk7XG59XG5cbi8qKlxuICogU2VuZCB3ZWIgcmVxdWVzdC5cbiAqIEBwYXJhbSB1cmwgUmVxdWVzdCB1cmwuXG4gKiBAcGFyYW0gbWV0aG9kIFJlcXVlc3QgbWV0aG9kLlxuICogQHBhcmFtIHBhcmFtcyBQYXJhbXMuXG4gKiBAcGFyYW0gZGF0YSBQb3N0IGRhdGEuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBuZXRSZXF1ZXN0KFxuICB1cmw6IHN0cmluZyxcbiAgbWV0aG9kOiBNZXRob2QsXG4gIHBhcmFtczogTWFwPHN0cmluZywgYW55PiB8IG51bGwgPSBudWxsLFxuICBkYXRhOiBhbnkgfCBudWxsID0gbnVsbCk6IFByb21pc2U8V2VjaGF0TWluaXByb2dyYW0uUmVxdWVzdFN1Y2Nlc3NDYWxsYmFja1Jlc3VsdD4ge1xuXG4gIC8vIGF1dGggcmVsYXRlZFxuICB2YXIgaGVhZGVycyA9IHt9XG4gIHZhciBhdXRob3JpemF0aW9uID0gYXBwLmF1dGg/LmFjY2Vzc1Rva2VuXG4gIGlmIChhdXRob3JpemF0aW9uICE9IG51bGwpIHtcbiAgICBpZiAoaXNFeHBpcmVkKCkpIHtcbiAgICAgIC8vIGxvZ2luIGFnYWluIHRvIHJlZnJlc2ggdG9rZW4uXG4gICAgICB3ZWNoYXRMb2dpbigocmVzKSA9PiB7XG4gICAgICAgIGxldCByZXN1bHQgPSA8V2VjaGF0QXV0aFJlc3VsdD5yZXMuZGF0YTtcbiAgICAgICAgYXBwLmF1dGggPSByZXN1bHQuYXV0aDtcbiAgICAgICAgYXBwLnVzZXIgPSByZXN1bHQudXNlcjtcbiAgICAgICAgaGVhZGVycyA9IHtcbiAgICAgICAgICBBdXRob3JpemF0aW9uOiBgQmVhcmVyICR7YXBwLmF1dGg/LmFjY2Vzc1Rva2VufWBcbiAgICAgICAgfTtcbiAgICAgIH0pO1xuXG4gICAgfSBlbHNlIHtcbiAgICAgIGhlYWRlcnMgPSB7XG4gICAgICAgIEF1dGhvcml6YXRpb246IGBCZWFyZXIgJHthcHAuYXV0aD8uYWNjZXNzVG9rZW59YFxuICAgICAgfTtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIGNyZWF0ZVJlcXVlc3RQcm9taXNlKHVybCwgbWV0aG9kLCBwYXJhbXMsIGRhdGEsIGhlYWRlcnMpO1xufVxuXG5cbmZ1bmN0aW9uIGNyZWF0ZVJlcXVlc3RQcm9taXNlKFxuICB1cmw6IHN0cmluZyxcbiAgbWV0aG9kOiBNZXRob2QsXG4gIHBhcmFtczogTWFwPHN0cmluZywgYW55PiB8IG51bGwgPSBudWxsLFxuICBkYXRhOiBhbnkgfCBudWxsID0gbnVsbCxcbiAgaGVhZGVyczogT2JqZWN0KTogUHJvbWlzZTxXZWNoYXRNaW5pcHJvZ3JhbS5SZXF1ZXN0U3VjY2Vzc0NhbGxiYWNrUmVzdWx0PiB7XG4gIHJldHVybiBuZXcgUHJvbWlzZTxXZWNoYXRNaW5pcHJvZ3JhbS5SZXF1ZXN0U3VjY2Vzc0NhbGxiYWNrUmVzdWx0PigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgd3gucmVxdWVzdCh7XG4gICAgICB1cmw6IGAke0NvbmZpZy5BUEl9JHt1cmx9JHtyZXNvbHZlUGFyYW1zKHBhcmFtcyl9YCxcbiAgICAgIGRhdGE6IGRhdGEsXG4gICAgICBtZXRob2Q6IG1ldGhvZCxcbiAgICAgIGhlYWRlcjogaGVhZGVycyxcbiAgICAgIGRhdGFUeXBlOiBcImpzb25cIixcbiAgICAgIHJlc3BvbnNlVHlwZTogXCJ0ZXh0XCIsXG4gICAgICBzdWNjZXNzOiAocmVzOiBXZWNoYXRNaW5pcHJvZ3JhbS5SZXF1ZXN0U3VjY2Vzc0NhbGxiYWNrUmVzdWx0KSA9PiB7XG4gICAgICAgIGlmIChpc1N1Y2Nlc3MocmVzKSkge1xuICAgICAgICAgIHJlc29sdmUocmVzKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZWplY3QocmVzKTtcbiAgICAgICAgfVxuICAgICAgfSxcblxuICAgICAgZmFpbDogKHJlczogV2VjaGF0TWluaXByb2dyYW0uQWNjZXNzRmFpbENhbGxiYWNrUmVzdWx0KSA9PiB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJ3JlcXVlc3QgZXJyb3InKTtcbiAgICAgICAgcmVqZWN0KHJlcyk7XG4gICAgICB9LFxuXG4gICAgICBjb21wbGV0ZTogKHJlczogV2VjaGF0TWluaXByb2dyYW0uR2VuZXJhbENhbGxiYWNrUmVzdWx0KSA9PiB7XG4gICAgICAgIC8vIGRvIHNvbWV0aGluZyBhZnRlclxuICAgICAgfVxuICAgIH0pO1xuICB9KTtcbn1cblxuXG5cbmZ1bmN0aW9uIGlzRXhwaXJlZCgpOiBib29sZWFuIHtcbiAgcmV0dXJuIGFwcC5hdXRoISEuZXhwaXJhdGlvbiA8IG5ldyBEYXRlKCkuZ2V0TWlsbGlzZWNvbmRzKCk7XG59XG5cbi8qKlxuICogUmVxdWVzdCBwYXJhbXMuXG4gKi9cbmZ1bmN0aW9uIHJlc29sdmVQYXJhbXMocGFyYW1zOiBNYXA8c3RyaW5nLCBzdHJpbmc+IHwgbnVsbCk6IHN0cmluZyB7XG4gIGlmIChwYXJhbXMgIT0gbnVsbCkge1xuICAgIGxldCBwYXJhbXNTdHIgPSAnPydcbiAgICBwYXJhbXMuZm9yRWFjaCgodmFsdWUsIGtleSkgPT4ge1xuICAgICAgcGFyYW1zU3RyICs9IGAke2tleX09JHt2YWx1ZX0mYDtcbiAgICB9KTtcbiAgICByZXR1cm4gcGFyYW1zU3RyLnN1YnN0cmluZygwLCBwYXJhbXNTdHIubGVuZ3RoIC0gMSk7XG4gIH1cbiAgcmV0dXJuICcnO1xufVxuXG5cbmZ1bmN0aW9uIGlzU3VjY2VzcyhyZXM6IFdlY2hhdE1pbmlwcm9ncmFtLlJlcXVlc3RTdWNjZXNzQ2FsbGJhY2tSZXN1bHQpOiBib29sZWFuIHtcbiAgbGV0IHN0YXR1c0NvZGUgPSBTdHJpbmcocmVzLnN0YXR1c0NvZGUpO1xuXG4gIHJldHVybiAhc2VydmVyRXJyb3JQYXR0ZXJuLnRlc3Qoc3RhdHVzQ29kZSkgJiYgIWNsaWVudEVycm9yUGF0dGVybi50ZXN0KHN0YXR1c0NvZGUpO1xufSJdfQ==