"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.netRequest = exports.uploadFile = void 0;
const config_1 = require("../config/config");
const util_1 = require("./util");
const app = (getApp());
const serverErrorPattern = new RegExp('^5..$');
const clientErrorPattern = new RegExp('^4..$');
const redirectPattern = new RegExp('^3..$');
const okPattern = new RegExp('^2..$');
function uploadFile(filePath, folder, self) {
    let key = `${config_1.default.OSS_BUCKET}/${folder}/${util_1.uuid()}`;
    ossSignature().then((res) => {
        let signature = res.data;
        let uploader = wx.uploadFile({
            url: config_1.default.OSS_ROOT,
            filePath: filePath,
            name: 'file',
            formData: {
                name: filePath,
                key: key,
                policy: signature.policy,
                OSSAccessKeyId: signature.ossAccessKeyId,
                signature: signature.signature,
                success_action_status: "200",
                'x-oss-security-token': signature.securityToken
            },
            success: (res) => {
                if (res.statusCode === 204) {
                    console.log('上传成功');
                }
                self.setData({
                    imageSrc: `${config_1.default.OSS_ROOT}/${key}`
                });
            },
            fail: err => {
                console.log(err);
            }
        });
        uploader.onProgressUpdate(res => {
            self.setData({
                uploadProgress: res.progress
            });
        });
    }).catch((res) => {
        console.error(res);
    });
}
exports.uploadFile = uploadFile;
function ossSignature() {
    return netRequest('/aliyun/oss-signature', 'GET');
}
function netRequest(url, method, params = null, data = null) {
    var _a, _b;
    var header = {};
    var authorization = (_a = app.auth) === null || _a === void 0 ? void 0 : _a.accessToken;
    if (authorization != null) {
        if (isExpired()) {
            util_1.wechatLogin((res) => {
                var _a;
                let result = res.data;
                app.auth = result.auth;
                app.user = result.user;
                header = {
                    Authorization: `Bearer ${(_a = app.auth) === null || _a === void 0 ? void 0 : _a.accessToken}`
                };
            });
        }
        else {
            header = {
                Authorization: `Bearer ${(_b = app.auth) === null || _b === void 0 ? void 0 : _b.accessToken}`
            };
        }
    }
    let promise = new Promise((resolve, reject) => {
        wx.request({
            url: `${config_1.default.API}${url}${resolveParams(params)}`,
            data: data,
            method: method,
            header: header,
            dataType: "json",
            responseType: "text",
            success: (res) => {
                if (isSuccess(res)) {
                    resolve(res);
                }
                else {
                    reject(res);
                }
            },
            fail: (res) => {
                console.error('request error');
                reject(res);
            },
            complete: (res) => {
            }
        });
    });
    return promise;
}
exports.netRequest = netRequest;
function isExpired() {
    return app.auth.expiration < new Date().getMilliseconds();
}
function resolveParams(params) {
    if (params != null) {
        let paramsStr = '?';
        params.forEach((key, value) => {
            paramsStr += `${key}=${value}&`;
        });
        return paramsStr.substring(0, paramsStr.length - 1);
    }
    return '';
}
function isSuccess(res) {
    let statusCode = String(res.statusCode);
    return !serverErrorPattern.test(statusCode) && !clientErrorPattern.test(statusCode);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmV0d29yay5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIm5ldHdvcmsudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBRUEsNkNBQXNDO0FBQ3RDLGlDQUEyQztBQUUzQyxNQUFNLEdBQUcsR0FBZ0IsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDO0FBR3BDLE1BQU0sa0JBQWtCLEdBQUcsSUFBSSxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUM7QUFHL0MsTUFBTSxrQkFBa0IsR0FBRyxJQUFJLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQztBQUcvQyxNQUFNLGVBQWUsR0FBRyxJQUFJLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQztBQUc1QyxNQUFNLFNBQVMsR0FBRyxJQUFJLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQztBQUl0QyxTQUFnQixVQUFVLENBQUMsUUFBZ0IsRUFBRSxNQUFjLEVBQUUsSUFBeUQ7SUFDcEgsSUFBSSxHQUFHLEdBQUcsR0FBRyxnQkFBTSxDQUFDLFVBQVUsSUFBSSxNQUFNLElBQUksV0FBSSxFQUFFLEVBQUUsQ0FBQztJQUNyRCxZQUFZLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFtRCxFQUFFLEVBQUU7UUFDMUUsSUFBSSxTQUFTLEdBQWlCLEdBQUcsQ0FBQyxJQUFJLENBQUM7UUFFdkMsSUFBSSxRQUFRLEdBQUcsRUFBRSxDQUFDLFVBQVUsQ0FBQztZQUMzQixHQUFHLEVBQUUsZ0JBQU0sQ0FBQyxRQUFRO1lBQ3BCLFFBQVEsRUFBRSxRQUFRO1lBQ2xCLElBQUksRUFBRSxNQUFNO1lBQ1osUUFBUSxFQUFFO2dCQUNSLElBQUksRUFBRSxRQUFRO2dCQUNkLEdBQUcsRUFBRSxHQUFHO2dCQUNSLE1BQU0sRUFBRSxTQUFTLENBQUMsTUFBTTtnQkFDeEIsY0FBYyxFQUFFLFNBQVMsQ0FBQyxjQUFjO2dCQUN4QyxTQUFTLEVBQUUsU0FBUyxDQUFDLFNBQVM7Z0JBQzlCLHFCQUFxQixFQUFFLEtBQUs7Z0JBQzVCLHNC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QUFDLENBQUM7Z0JBQy9CLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUNkLENBQUM7WUFFRCxRQUFRLEVBQUUsQ0FBQyxHQUE0QyxFQUFFLEVBQUU7WUFFM0QsQ0FBQztTQUNGLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFBO0lBQ0YsT0FBTyxPQUFPLENBQUM7QUFDakIsQ0FBQztBQXZERCxnQ0F1REM7QUFJRCxTQUFTLFNBQVM7SUFDaEIsT0FBTyxHQUFHLENBQUMsSUFBTSxDQUFDLFVBQVUsR0FBRyxJQUFJLElBQUksRUFBRSxDQUFDLGVBQWUsRUFBRSxDQUFDO0FBQzlELENBQUM7QUFLRCxTQUFTLGFBQWEsQ0FBQyxNQUFrQztJQUN2RCxJQUFJLE1BQU0sSUFBSSxJQUFJLEVBQUU7UUFDbEIsSUFBSSxTQUFTLEdBQUcsR0FBRyxDQUFBO1FBQ25CLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxHQUFHLEVBQUUsS0FBSyxFQUFFLEVBQUU7WUFDNUIsU0FBUyxJQUFJLEdBQUcsR0FBRyxJQUFJLEtBQUssR0FBRyxDQUFDO1FBQ2xDLENBQUMsQ0FBQyxDQUFDO1FBQ0gsT0FBTyxTQUFTLENBQUMsU0FBUyxDQUFDLENBQUMsRUFBRSxTQUFTLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDO0tBQ3JEO0lBQ0QsT0FBTyxFQUFFLENBQUM7QUFDWixDQUFDO0FBR0QsU0FBUyxTQUFTLENBQUMsR0FBbUQ7SUFDcEUsSUFBSSxVQUFVLEdBQUcsTUFBTSxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQztJQUV4QyxPQUFPLENBQUMsa0JBQWtCLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO0FBQ3RGLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBpbXBvcnQgJ21pbmlwcm9ncmFtLWFwaS10eXBpbmdzJztcbi8vLyA8cmVmZXJlbmNlIGxpYj1cImRvbVwiIC8+XG5pbXBvcnQgQ29uZmlnIGZyb20gXCIuLi9jb25maWcvY29uZmlnXCI7XG5pbXBvcnQgeyB1dWlkLCB3ZWNoYXRMb2dpbiB9IGZyb20gXCIuL3V0aWxcIjtcblxuY29uc3QgYXBwID0gPE15QXBwT3B0aW9uPihnZXRBcHAoKSk7XG5cbi8vIDV4eCBzdGF0dXMgY29kZVxuY29uc3Qgc2VydmVyRXJyb3JQYXR0ZXJuID0gbmV3IFJlZ0V4cCgnXjUuLiQnKTsgLy8gb3IgL141Li4kL1xuXG4vLyA0eHhcbmNvbnN0IGNsaWVudEVycm9yUGF0dGVybiA9IG5ldyBSZWdFeHAoJ140Li4kJyk7XG5cbi8vIDN4eFxuY29uc3QgcmVkaXJlY3RQYXR0ZXJuID0gbmV3IFJlZ0V4cCgnXjMuLiQnKTtcblxuLy8gMnh4XG5jb25zdCBva1BhdHRlcm4gPSBuZXcgUmVnRXhwKCdeMi4uJCcpO1xuXG5cblxuZXhwb3J0IGZ1bmN0aW9uIHVwbG9hZEZpbGUoZmlsZVBhdGg6IHN0cmluZywgZm9sZGVyOiBzdHJpbmcsIHNlbGY6IFdlY2hhdE1pbmlwcm9ncmFtLkNvbXBvbmVudC5JbnN0YW5jZTxhbnksIGFueSwgYW55Pikge1xuICBsZXQga2V5ID0gYCR7Q29uZmlnLk9TU19CVUNLRVR9LyR7Zm9sZGVyfS8ke3V1aWQoKX1gO1xuICBvc3NTaWduYXR1cmUoKS50aGVuKChyZXM6IFdlY2hhdE1pbmlwcm9ncmFtLlJlcXVlc3RTdWNjZXNzQ2FsbGJhY2tSZXN1bHQpID0+IHtcbiAgICBsZXQgc2lnbmF0dXJlID0gPE9zc1NpZ25hdHVyZT5yZXMuZGF0YTtcblxuICAgIGxldCB1cGxvYWRlciA9IHd4LnVwbG9hZEZpbGUoe1xuICAgICAgdXJsOiBDb25maWcuT1NTX1JPT1QsIC8vIOW8gOWPkeiAheacjeWKoeWZqOeahFVSTOOAglxuICAgICAgZmlsZVBhdGg6IGZpbGVQYXRoLFxuICAgICAgbmFtZTogJ2ZpbGUnLCAvLyDlv4XpobvloatmaWxl44CCXG4gICAgICBmb3JtRGF0YToge1xuICAgICAgICBuYW1lOiBmaWxlUGF0aCxcbiAgICAgICAga2V5OiBrZXksXG4gICAgICAgIHBvbGljeTogc2lnbmF0dXJlLnBvbGljeSxcbiAgICAgICAgT1NTQWNjZXNzS2V5SWQ6IHNpZ25hdHVyZS5vc3NBY2Nlc3NLZXlJZCxcbiAgICAgICAgc2lnbmF0dXJlOiBzaWduYXR1cmUuc2lnbmF0dXJlLFxuICAgICAgICBzdWNjZXNzX2FjdGlvbl9zdGF0dXM6IFwiMjAwXCIsXG4gICAgICAgICd4LW9zcy1zZWN1cml0eS10b2tlbic6IHNpZ25hdHVyZS5zZWN1cml0eVRva2VuIC8vIOS9v+eUqFNUU+etvuWQjeaXtuW/heS8oOOAglxuICAgICAgfSxcbiAgICAgIHN1Y2Nlc3M6IChyZXMpID0+IHtcbiAgICAgICAgaWYgKHJlcy5zdGF0dXNDb2RlID09PSAyMDQpIHtcbiAgICAgICAgICBjb25zb2xlLmxvZygn5LiK5Lyg5oiQ5YqfJyk7XG4gICAgICAgIH1cbiAgICAgICAgc2VsZi5zZXREYXRhKHtcbiAgICAgICAgICBpbWFnZVNyYzogYCR7Q29uZmlnLk9TU19ST09UfS8ke2tleX1gXG4gICAgICAgIH0pO1xuICAgICAgfSxcbiAgICAgIGZhaWw6IGVyciA9PiB7XG4gICAgICAgIGNvbnNvbGUubG9nKGVycik7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICB1cGxvYWRlci5vblByb2dyZXNzVXBkYXRlKHJlcyA9PiB7XG4gICAgICBzZWxmLnNldERhdGEoe1xuICAgICAgICB1cGxvYWRQcm9ncmVzczogcmVzLnByb2dyZXNzXG4gICAgICB9KTtcbiAgICB9KTtcbiAgfSkuY2F0Y2goKHJlczogV2VjaGF0TWluaXByb2dyYW0uUmVxdWVzdEZhaWxDYWxsYmFjaykgPT4ge1xuICAgIGNvbnNvbGUuZXJyb3IocmVzKTtcbiAgfSk7XG59XG5cblxuZnVuY3Rpb24gb3NzU2lnbmF0dXJlKCkge1xuICByZXR1cm4gbmV0UmVxdWVzdCgnL2FsaXl1bi9vc3Mtc2lnbmF0dXJlJywgJ0dFVCcpO1xufVxuXG4vKipcbiAqIFNlbmQgd2ViIHJlcXVlc3QuXG4gKiBAcGFyYW0gdXJsIFJlcXVlc3QgdXJsLlxuICogQHBhcmFtIG1ldGhvZCBSZXF1ZXN0IG1ldGhvZC5cbiAqIEBwYXJhbSBwYXJhbXMgUGFyYW1zLlxuICogQHBhcmFtIGRhdGEgUG9zdCBkYXRhLlxuICovXG5leHBvcnQgZnVuY3Rpb24gbmV0UmVxdWVzdChcbiAgdXJsOiBzdHJpbmcsXG4gIG1ldGhvZDogTWV0aG9kLFxuICBwYXJhbXM6IE1hcDxzdHJpbmcsIHN0cmluZz4gfCBudWxsID0gbnVsbCxcbiAgZGF0YTogYW55IHwgbnVsbCA9IG51bGwpIHtcbiAgXG4gIC8vIGF1dGggcmVsYXRlZFxuICB2YXIgaGVhZGVyID0ge31cbiAgdmFyIGF1dGhvcml6YXRpb24gPSBhcHAuYXV0aD8uYWNjZXNzVG9rZW5cbiAgaWYgKGF1dGhvcml6YXRpb24gIT0gbnVsbCkge1xuICAgIGlmIChpc0V4cGlyZWQoKSkge1xuICAgICAgLy8gbG9naW4gYWdhaW4gdG8gcmVmcmVzaCB0b2tlbi5cbiAgICAgIHdlY2hhdExvZ2luKChyZXMpID0+IHtcbiAgICAgICAgbGV0IHJlc3VsdCA9IDxXZWNoYXRBdXRoUmVzdWx0PnJlcy5kYXRhO1xuICAgICAgICBhcHAuYXV0aCA9IHJlc3VsdC5hdXRoO1xuICAgICAgICBhcHAudXNlciA9IHJlc3VsdC51c2VyO1xuICAgICAgICBoZWFkZXIgPSB7XG4gICAgICAgICAgQXV0aG9yaXphdGlvbjogYEJlYXJlciAke2FwcC5hdXRoPy5hY2Nlc3NUb2tlbn1gXG4gICAgICAgIH07XG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgaGVhZGVyID0ge1xuICAgICAgICBBdXRob3JpemF0aW9uOiBgQmVhcmVyICR7YXBwLmF1dGg/LmFjY2Vzc1Rva2VufWBcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICAvLyBsZXQgcmVxVVJMID0gdXJsXG4gIGxldCBwcm9taXNlID0gbmV3IFByb21pc2U8V2VjaGF0TWluaXByb2dyYW0uUmVxdWVzdFN1Y2Nlc3NDYWxsYmFja1Jlc3VsdD4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgIHd4LnJlcXVlc3Qoe1xuICAgICAgdXJsOiBgJHtDb25maWcuQVBJfSR7dXJsfSR7cmVzb2x2ZVBhcmFtcyhwYXJhbXMpfWAsXG4gICAgICBkYXRhOiBkYXRhLFxuICAgICAgbWV0aG9kOiBtZXRob2QsXG4gICAgICBoZWFkZXI6IGhlYWRlcixcbiAgICAgIGRhdGFUeXBlOiBcImpzb25cIixcbiAgICAgIHJlc3BvbnNlVHlwZTogXCJ0ZXh0XCIsXG4gICAgICBzdWNjZXNzOiAocmVzOiBXZWNoYXRNaW5pcHJvZ3JhbS5SZXF1ZXN0U3VjY2Vzc0NhbGxiYWNrUmVzdWx0KSA9PiB7XG4gICAgICAgIGlmIChpc1N1Y2Nlc3MocmVzKSkge1xuICAgICAgICAgIHJlc29sdmUocmVzKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZWplY3QocmVzKTtcbiAgICAgICAgfVxuICAgICAgfSxcblxuICAgICAgZmFpbDogKHJlczogV2VjaGF0TWluaXByb2dyYW0uQWNjZXNzRmFpbENhbGxiYWNrUmVzdWx0KSA9PiB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJ3JlcXVlc3QgZXJyb3InKTtcbiAgICAgICAgcmVqZWN0KHJlcyk7XG4gICAgICB9LFxuXG4gICAgICBjb21wbGV0ZTogKHJlczogV2VjaGF0TWluaXByb2dyYW0uR2VuZXJhbENhbGxiYWNrUmVzdWx0KSA9PiB7XG4gICAgICAgIC8vIGRvIHNvbWV0aGluZyBhZnRlclxuICAgICAgfVxuICAgIH0pO1xuICB9KVxuICByZXR1cm4gcHJvbWlzZTtcbn1cblxuXG5cbmZ1bmN0aW9uIGlzRXhwaXJlZCgpOiBib29sZWFuIHtcbiAgcmV0dXJuIGFwcC5hdXRoISEuZXhwaXJhdGlvbiA8IG5ldyBEYXRlKCkuZ2V0TWlsbGlzZWNvbmRzKCk7XG59XG5cbi8qKlxuICogUmVxdWVzdCBwYXJhbXMuXG4gKi9cbmZ1bmN0aW9uIHJlc29sdmVQYXJhbXMocGFyYW1zOiBNYXA8c3RyaW5nLCBzdHJpbmc+IHwgbnVsbCk6IHN0cmluZyB7XG4gIGlmIChwYXJhbXMgIT0gbnVsbCkge1xuICAgIGxldCBwYXJhbXNTdHIgPSAnPydcbiAgICBwYXJhbXMuZm9yRWFjaCgoa2V5LCB2YWx1ZSkgPT4ge1xuICAgICAgcGFyYW1zU3RyICs9IGAke2tleX09JHt2YWx1ZX0mYDtcbiAgICB9KTtcbiAgICByZXR1cm4gcGFyYW1zU3RyLnN1YnN0cmluZygwLCBwYXJhbXNTdHIubGVuZ3RoIC0gMSk7XG4gIH1cbiAgcmV0dXJuICcnO1xufVxuXG5cbmZ1bmN0aW9uIGlzU3VjY2VzcyhyZXM6IFdlY2hhdE1pbmlwcm9ncmFtLlJlcXVlc3RTdWNjZXNzQ2FsbGJhY2tSZXN1bHQpOiBib29sZWFuIHtcbiAgbGV0IHN0YXR1c0NvZGUgPSBTdHJpbmcocmVzLnN0YXR1c0NvZGUpO1xuXG4gIHJldHVybiAhc2VydmVyRXJyb3JQYXR0ZXJuLnRlc3Qoc3RhdHVzQ29kZSkgJiYgIWNsaWVudEVycm9yUGF0dGVybi50ZXN0KHN0YXR1c0NvZGUpO1xufSJdfQ==